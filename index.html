<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>2 Truths and a Lie Game</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database.min.js"></script>
        <style>
            :root {
                --primary-color: #4a6fa5;
                --secondary-color: #166088;
                --accent-color: #4fc3f7;
                --background-color: #f5f5f5;
                --text-color: #333;
                --card-background: #fff;
                --danger-color: #e74c3c;
                --success-color: #2ecc71;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background-color: var(--background-color);
                color: var(--text-color);
                line-height: 1.6;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                font-size: 2.5rem;
                color: var(--primary-color);
                margin-bottom: 10px;
            }

            .header p {
                font-size: 1.2rem;
                color: var(--secondary-color);
            }

            .card {
                background-color: var(--card-background);
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }

            .buttons {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
            }

            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background-color: var(--primary-color);
                color: white;
            }

            .btn-primary:hover {
                background-color: var(--secondary-color);
            }

            .btn-secondary {
                background-color: var(--accent-color);
                color: white;
            }

            .btn-secondary:hover {
                opacity: 0.9;
            }

            .btn-danger {
                background-color: var(--danger-color);
                color: white;
            }

            .btn-danger:hover {
                opacity: 0.9;
            }

            .btn-success {
                background-color: var(--success-color);
                color: white;
            }

            .btn-success:hover {
                opacity: 0.9;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
            }

            .form-control {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 1rem;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--accent-color);
            }

            .player-list {
                margin-top: 20px;
            }

            .player-item {
                padding: 10px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .player-name {
                font-weight: 600;
            }

            .player-status {
                font-size: 0.9rem;
                color: #666;
            }

            .player-status.completed {
                color: var(--success-color);
            }

            .statement {
                margin-bottom: 15px;
                padding: 10px;
                background-color: #f9f9f9;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .statement:hover {
                background-color: #f0f0f0;
            }

            .statement.selected {
                background-color: var(--accent-color);
                color: white;
            }

            .statement.truth {
                background-color: var(--success-color);
                color: white;
            }

            .statement.lie {
                background-color: var(--danger-color);
                color: white;
            }

            .hidden {
                display: none;
            }

            .copies {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
            }

            .copy-field {
                flex: 1;
                margin-right: 10px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 0.9rem;
                background-color: #f9f9f9;
                cursor: text;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            .results {
                margin-top: 20px;
            }

            .result-item {
                margin-bottom: 10px;
            }

            .player-name {
                font-weight: 600;
            }

            .game-code {
                font-size: 2rem;
                text-align: center;
                margin: 20px 0;
                color: var(--secondary-color);
                font-weight: bold;
            }

            .votes {
                display: flex;
                flex-wrap: wrap;
                margin-top: 10px;
            }

            .vote {
                background-color: #f0f0f0;
                border-radius: 20px;
                padding: 5px 10px;
                margin-right: 5px;
                margin-bottom: 5px;
                font-size: 0.9rem;
            }

            .instructions {
                margin-bottom: 20px;
                padding: 15px;
                background-color: rgba(79, 195, 247, 0.1);
                border-left: 4px solid var(--accent-color);
                border-radius: 4px;
            }

            .instructions h3 {
                color: var(--primary-color);
                margin-bottom: 10px;
            }

            .instructions p {
                margin-bottom: 10px;
            }

            .instructions ul {
                padding-left: 20px;
            }

            .instructions li {
                margin-bottom: 5px;
            }

            .waitingforplayers {
                text-align: center;
                padding: 20px;
                font-size: 1.2rem;
                color: #666;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 10px;
                }

                .header h1 {
                    font-size: 2rem;
                }

                .buttons {
                    flex-direction: column;
                }

                .btn {
                    margin-bottom: 10px;
                    width: 100%;
                }

                .copies {
                    flex-direction: column;
                }

                .copy-field {
                    margin-right: 0;
                    margin-bottom: 10px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>2 Truths and a Lie</h1>
                <p>A fun game of deception and discovery!</p>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="card">
                <div class="form-group">
                    <label for="player-name">Enter Your Name</label>
                    <input
                        type="text"
                        id="player-name"
                        class="form-control"
                        placeholder="Your Name"
                    />
                </div>
                <div class="buttons">
                    <button id="create-game" class="btn btn-primary">
                        Create Game (Host)
                    </button>
                    <button id="join-game" class="btn btn-secondary">
                        Join Game
                    </button>
                </div>
            </div>

            <!-- Join Game Screen -->
            <div id="join-screen" class="card hidden">
                <div class="form-group">
                    <label for="game-code-input">Enter Game Code</label>
                    <input
                        type="text"
                        id="game-code-input"
                        class="form-control"
                        placeholder="Game Code"
                    />
                </div>
                <div class="buttons">
                    <button id="join-game-submit" class="btn btn-primary">
                        Join
                    </button>
                    <button id="back-to-home" class="btn btn-secondary">
                        Back
                    </button>
                </div>
            </div>

            <!-- Host Lobby Screen -->
            <div id="host-lobby" class="card hidden">
                <h2>Game Lobby</h2>
                <div class="game-code" id="game-code-display"></div>
                <div class="instructions">
                    <h3>How to Play:</h3>
                    <p>1. Share the game code with your friends.</p>
                    <p>
                        2. Wait for all players to submit their 2 truths and a
                        lie.
                    </p>
                    <p>3. When everyone is ready, start the game.</p>
                    <p>
                        4. For each player, everyone will guess which statement
                        is the lie.
                    </p>
                    <p>5. The host will reveal the correct answer.</p>
                </div>
                <div class="copies">
                    <div id="copy-link" class="copy-field">
                        Share this link:
                    </div>
                    <button id="copy-link-btn" class="btn btn-secondary">
                        Copy Link
                    </button>
                </div>
                <div class="player-list" id="player-list">
                    <div class="waitingforplayers">
                        Waiting for players to join...
                    </div>
                </div>
                <div class="buttons">
                    <button id="start-game" class="btn btn-success" disabled>
                        Start Game
                    </button>
                    <button id="leave-game" class="btn btn-danger">
                        End Game
                    </button>
                </div>
            </div>

            <!-- Player Input Screen -->
            <div id="player-input" class="card hidden">
                <h2>Enter Your Statements</h2>
                <div class="instructions">
                    <h3>Instructions:</h3>
                    <p>
                        Enter 2 true statements and 1 false statement about
                        yourself.
                    </p>
                    <p>Make them challenging but not impossible to guess!</p>
                </div>
                <div class="form-group">
                    <label for="statement1">Statement 1</label>
                    <input
                        type="text"
                        id="statement1"
                        class="form-control"
                        placeholder="Enter statement 1"
                    />
                </div>
                <div class="form-group">
                    <label for="statement2">Statement 2</label>
                    <input
                        type="text"
                        id="statement2"
                        class="form-control"
                        placeholder="Enter statement 2"
                    />
                </div>
                <div class="form-group">
                    <label for="statement3">Statement 3</label>
                    <input
                        type="text"
                        id="statement3"
                        class="form-control"
                        placeholder="Enter statement 3"
                    />
                </div>
                <div class="form-group">
                    <label for="lie-select"
                        >Select which statement is the lie:</label
                    >
                    <select id="lie-select" class="form-control">
                        <option value="1">Statement 1</option>
                        <option value="2">Statement 2</option>
                        <option value="3">Statement 3</option>
                    </select>
                </div>
                <div class="buttons">
                    <button id="submit-statements" class="btn btn-primary">
                        Submit
                    </button>
                </div>
            </div>

            <!-- Player Waiting Screen -->
            <div id="player-waiting" class="card hidden">
                <h2>Waiting for Other Players</h2>
                <p>Your statements have been submitted!</p>
                <p>Waiting for other players to submit their statements...</p>
                <div class="game-code" id="player-game-code-display"></div>
                <div class="player-list" id="player-waiting-list">
                    <div class="waitingforplayers">Loading players...</div>
                </div>
                <div class="buttons">
                    <button id="leave-game-player" class="btn btn-danger">
                        Leave Game
                    </button>
                </div>
            </div>

            <!-- Game Play Screen - Host View -->
            <div id="game-play-host" class="card hidden">
                <h2>Game Play</h2>
                <div class="current-player" id="current-player">
                    <h3>
                        Current Player: <span id="current-player-name"></span>
                    </h3>
                    <div id="statement-container">
                        <div class="statement" id="statement-1">
                            Statement 1
                        </div>
                        <div class="statement" id="statement-2">
                            Statement 2
                        </div>
                        <div class="statement" id="statement-3">
                            Statement 3
                        </div>
                    </div>
                    <div class="votes-container">
                        <h4>Votes:</h4>
                        <div class="votes" id="votes-display"></div>
                    </div>
                    <div class="buttons">
                        <button id="reveal-lie" class="btn btn-primary">
                            Reveal Lie
                        </button>
                    </div>
                </div>
                <div class="buttons">
                    <button id="next-player" class="btn btn-secondary hidden">
                        Next Player
                    </button>
                    <button id="end-game" class="btn btn-danger">
                        End Game
                    </button>
                </div>
            </div>

            <!-- Game Play Screen - Player View (Guessing) -->
            <div id="game-play-player" class="card hidden">
                <h2>Game Play</h2>
                <div class="current-player">
                    <h3>
                        Current Player:
                        <span id="current-player-name-player"></span>
                    </h3>
                    <div id="statement-container-player">
                        <div
                            class="statement"
                            id="statement-1-player"
                            data-id="1"
                        >
                            Statement 1
                        </div>
                        <div
                            class="statement"
                            id="statement-2-player"
                            data-id="2"
                        >
                            Statement 2
                        </div>
                        <div
                            class="statement"
                            id="statement-3-player"
                            data-id="3"
                        >
                            Statement 3
                        </div>
                    </div>
                    <div id="player-guess-instructions">
                        <p>Click on the statement you think is the lie!</p>
                    </div>
                    <div id="player-vote-status" class="hidden">
                        <p>
                            Your vote has been submitted! Waiting for other
                            players...
                        </p>
                    </div>
                    <div id="player-waiting-reveal" class="hidden">
                        <p>The host will reveal the lie soon...</p>
                    </div>
                </div>
            </div>

            <!-- Game Results Screen -->
            <div id="game-results" class="card hidden">
                <h2>Game Results</h2>
                <div class="results" id="results-container">
                    <!-- Results will be populated here -->
                </div>
                <div class="buttons">
                    <button id="play-again" class="btn btn-primary">
                        Play Again
                    </button>
                    <button id="exit-game" class="btn btn-secondary">
                        Exit
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBRQzO6vSbwJhgBHF_PBKaYMJLs4DUd_4o",
                authDomain: "two-truths-lie-game.firebaseapp.com",
                databaseURL:
                    "https://two-truths-lie-game-default-rtdb.firebaseio.com",
                projectId: "two-truths-lie-game",
                storageBucket: "two-truths-lie-game.appspot.com",
                messagingSenderId: "765169302928",
                appId: "1:765169302928:web:d9cf8dafeb0a4bed6c3b66",
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            // Game state
            let gameState = {
                gameId: null,
                playerId: null,
                playerName: "",
                isHost: false,
                players: {},
                currentPlayerIndex: 0,
                currentPlayerId: null,
                revealedLie: false,
                voted: false,
                gameStarted: false,
            };

            // DOM Elements
            const screens = {
                home: document.getElementById("home-screen"),
                join: document.getElementById("join-screen"),
                hostLobby: document.getElementById("host-lobby"),
                playerInput: document.getElementById("player-input"),
                playerWaiting: document.getElementById("player-waiting"),
                gamePlayHost: document.getElementById("game-play-host"),
                gamePlayPlayer: document.getElementById("game-play-player"),
                gameResults: document.getElementById("game-results"),
            };

            // Generate a random game code
            function generateGameCode() {
                const characters = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
                let result = "";
                for (let i = 0; i < 6; i++) {
                    result += characters.charAt(
                        Math.floor(Math.random() * characters.length)
                    );
                }
                return result;
            }

            // Generate a random player ID
            function generatePlayerId() {
                return "player_" + Math.random().toString(36).substr(2, 9);
            }

            // Show a specific screen
            function showScreen(screenId) {
                Object.values(screens).forEach((screen) =>
                    screen.classList.add("hidden")
                );
                screens[screenId].classList.remove("hidden");
            }

            // Update player list
            function updatePlayerList(players, containerId) {
                const playerListElement = document.getElementById(containerId);
                playerListElement.innerHTML = "";

                if (Object.keys(players).length === 0) {
                    playerListElement.innerHTML =
                        '<div class="waitingforplayers">Waiting for players to join...</div>';
                    return;
                }

                Object.keys(players).forEach((playerId) => {
                    const player = players[playerId];
                    const playerElement = document.createElement("div");
                    playerElement.className = "player-item";
                    playerElement.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-status ${
                        player.submitted ? "completed" : ""
                    }">${player.submitted ? "Ready" : "Not Ready"}</div>
                `;
                    playerListElement.appendChild(playerElement);
                });
            }

            // Create a new game
            function createGame() {
                const playerName = document
                    .getElementById("player-name")
                    .value.trim();
                if (!playerName) {
                    alert("Please enter your name!");
                    return;
                }

                const gameCode = generateGameCode();
                const playerId = generatePlayerId();

                gameState = {
                    gameId: gameCode,
                    playerId: playerId,
                    playerName: playerName,
                    isHost: true,
                    players: {},
                    currentPlayerIndex: 0,
                    currentPlayerId: null,
                    revealedLie: false,
                    voted: false,
                    gameStarted: false,
                };

                // Create game in Firebase
                database
                    .ref(`games/${gameCode}`)
                    .set({
                        host: playerId,
                        status: "lobby",
                        players: {
                            [playerId]: {
                                name: playerName,
                                isHost: true,
                                submitted: false,
                            },
                        },
                    })
                    .then(() => {
                        document.getElementById(
                            "game-code-display"
                        ).textContent = gameCode;
                        document.getElementById(
                            "copy-link"
                        ).textContent = `Share this link: ${window.location.href}?game=${gameCode}`;
                        showScreen("hostLobby");

                        // Listen for player changes
                        database
                            .ref(`games/${gameCode}/players`)
                            .on("value", (snapshot) => {
                                const players = snapshot.val() || {};
                                gameState.players = players;
                                updatePlayerList(players, "player-list");

                                // Enable start game button if at least one player has submitted
                                const startButton =
                                    document.getElementById("start-game");
                                const allSubmitted = Object.values(
                                    players
                                ).every((player) => player.submitted);
                                const hasEnoughPlayers =
                                    Object.keys(players).length >= 2;

                                startButton.disabled = !(
                                    allSubmitted && hasEnoughPlayers
                                );
                            });

                        // Listen for game status changes
                        database
                            .ref(`games/${gameCode}/status`)
                            .on("value", (snapshot) => {
                                const status = snapshot.val();
                                if (
                                    status === "playing" &&
                                    !gameState.gameStarted
                                ) {
                                    gameState.gameStarted = true;
                                    startGameForHost();
                                }
                            });
                    })
                    .catch((error) => {
                        console.error("Error creating game:", error);
                        alert("Error creating game. Please try again.");
                    });
            }

            // Join an existing game
            function joinGame() {
                const gameCode = document
                    .getElementById("game-code-input")
                    .value.trim()
                    .toUpperCase();
                if (!gameCode) {
                    alert("Please enter a game code!");
                    return;
                }

                // Check if game exists
                database.ref(`games/${gameCode}`).once("value", (snapshot) => {
                    const gameData = snapshot.val();
                    if (!gameData) {
                        alert(
                            "Game not found. Please check the code and try again."
                        );
                        return;
                    }

                    if (gameData.status === "playing") {
                        alert("Game already in progress. You cannot join now.");
                        return;
                    }

                    const playerName = document
                        .getElementById("player-name")
                        .value.trim();
                    if (!playerName) {
                        alert("Please enter your name!");
                        return;
                    }

                    const playerId = generatePlayerId();

                    gameState = {
                        gameId: gameCode,
                        playerId: playerId,
                        playerName: playerName,
                        isHost: false,
                        players: gameData.players || {},
                        currentPlayerIndex: 0,
                        currentPlayerId: null,
                        revealedLie: false,
                        voted: false,
                        gameStarted: false,
                    };

                    // Add player to the game
                    database
                        .ref(`games/${gameCode}/players/${playerId}`)
                        .set({
                            name: playerName,
                            isHost: false,
                            submitted: false,
                        })
                        .then(() => {
                            document.getElementById(
                                "player-game-code-display"
                            ).textContent = gameCode;
                            showScreen("playerInput");

                            // Listen for game status changes
                            database
                                .ref(`games/${gameCode}/status`)
                                .on("value", (snapshot) => {
                                    const status = snapshot.val();
                                    if (
                                        status === "playing" &&
                                        !gameState.gameStarted
                                    ) {
                                        gameState.gameStarted = true;
                                        startGameForPlayer();
                                    }
                                });

                            // Listen for player changes
                            database
                                .ref(`games/${gameCode}/players`)
                                .on("value", (snapshot) => {
                                    gameState.players = snapshot.val() || {};
                                    updatePlayerList(
                                        gameState.players,
                                        "player-waiting-list"
                                    );
                                });
                        })
                        .catch((error) => {
                            console.error("Error joining game:", error);
                            alert("Error joining game. Please try again.");
                        });
                });
            }

            // Submit player statements
            function submitStatements() {
                const statement1 = document
                    .getElementById("statement1")
                    .value.trim();
                const statement2 = document
                    .getElementById("statement2")
                    .value.trim();
                const statement3 = document
                    .getElementById("statement3")
                    .value.trim();
                const lieIndex = document.getElementById("lie-select").value;

                if (!statement1 || !statement2 || !statement3) {
                    alert("Please fill in all statements!");
                    return;
                }

                const statements = [statement1, statement2, statement3];

                database
                    .ref(
                        `games/${gameState.gameId}/players/${gameState.playerId}`
                    )
                    .update({
                        statements: statements,
                        lieIndex: lieIndex,
                        submitted: true,
                    })
                    .then(() => {
                        showScreen("playerWaiting");
                        updatePlayerList(
                            gameState.players,
                            "player-waiting-list"
                        );
                    })
                    .catch((error) => {
                        console.error("Error submitting statements:", error);
                        alert("Error submitting statements. Please try again.");
                    });
            }

            // Start the game (host)
            function startGame() {
                database
                    .ref(`games/${gameState.gameId}`)
                    .update({
                        status: "playing",
                        currentPlayerIndex: 0,
                    })
                    .then(() => {
                        startGameForHost();
                    })
                    .catch((error) => {
                        console.error("Error starting game:", error);
                        alert("Error starting game. Please try again.");
                    });
            }

            // Start the game for host
            function startGameForHost() {
                showScreen("gamePlayHost");

                // Get all players with submitted statements
                const playersArray = Object.keys(gameState.players)
                    .filter((playerId) => gameState.players[playerId].submitted)
                    .map((playerId) => ({
                        id: playerId,
                        ...gameState.players[playerId],
                    }));

                if (playersArray.length === 0) {
                    alert("No players have submitted statements.");
                    return;
                }

                // Setup game state
                gameState.currentPlayerIndex = 0;
                gameState.currentPlayerId = playersArray[0].id;

                // Set up listeners for votes
                database
                    .ref(`games/${gameState.gameId}/votes`)
                    .on("value", (snapshot) => {
                        const votes = snapshot.val() || {};
                        updateVotesDisplay(votes);
                    });

                // Set up listener for current player
                database
                    .ref(`games/${gameState.gameId}/currentPlayerIndex`)
                    .on("value", (snapshot) => {
                        const index = snapshot.val() || 0;
                        gameState.currentPlayerIndex = index;
                        updateCurrentPlayer();
                    });

                updateCurrentPlayer();
            }

            // Start the game for player
            function startGameForPlayer() {
                showScreen("gamePlayPlayer");

                // Set up listener for current player
                database
                    .ref(`games/${gameState.gameId}/currentPlayerIndex`)
                    .on("value", (snapshot) => {
                        const index = snapshot.val() || 0;
                        gameState.currentPlayerIndex = index;
                        updateCurrentPlayerForPlayer();
                    });

                // Set up listener for revealed lie
                database
                    .ref(`games/${gameState.gameId}/revealedLie`)
                    .on("value", (snapshot) => {
                        const revealed = snapshot.val();
                        if (revealed) {
                            revealLieForPlayer(revealed);
                        }
                    });

                // Set up listener for votes
                database
                    .ref(`games/${gameState.gameId}/votes`)
                    .on("value", (snapshot) => {
                        const votes = snapshot.val() || {};
                        checkIfVoted(votes);
                    });
            }

            // Update current player display for host
            function updateCurrentPlayer() {
                const playersArray = Object.keys(gameState.players)
                    .filter((playerId) => gameState.players[playerId].submitted)
                    .map((playerId) => ({
                        id: playerId,
                        ...gameState.players[playerId],
                    }));

                if (
                    playersArray.length === 0 ||
                    gameState.currentPlayerIndex >= playersArray.length
                ) {
                    showGameResults();
                    return;
                }

                const currentPlayer =
                    playersArray[gameState.currentPlayerIndex];
                gameState.currentPlayerId = currentPlayer.id;

                document.getElementById("current-player-name").textContent =
                    currentPlayer.name;
                document.getElementById("statement-1").textContent =
                    currentPlayer.statements[0];
                document.getElementById("statement-2").textContent =
                    currentPlayer.statements[1];
                document.getElementById("statement-3").textContent =
                    currentPlayer.statements[2];

                // Reset statements
                document
                    .querySelectorAll("#statement-container .statement")
                    .forEach((el) => {
                        el.classList.remove("truth", "lie", "selected");
                    });

                // Reset vote display
                document.getElementById("votes-display").innerHTML = "";

                // Reset revealed lie
                gameState.revealedLie = false;
                document
                    .getElementById("reveal-lie")
                    .classList.remove("hidden");
                document.getElementById("next-player").classList.add("hidden");

                // Reset votes
                database.ref(`games/${gameState.gameId}/votes`).set({});
                database.ref(`games/${gameState.gameId}/revealedLie`).set(null);
            }

            // Update current player display for player
            function updateCurrentPlayerForPlayer() {
                const playersArray = Object.keys(gameState.players)
                    .filter((playerId) => gameState.players[playerId].submitted)
                    .map((playerId) => ({
                        id: playerId,
                        ...gameState.players[playerId],
                    }));

                if (
                    playersArray.length === 0 ||
                    gameState.currentPlayerIndex >= playersArray.length
                ) {
                    return;
                }

                const currentPlayer =
                    playersArray[gameState.currentPlayerIndex];
                gameState.currentPlayerId = currentPlayer.id;

                document.getElementById(
                    "current-player-name-player"
                ).textContent = currentPlayer.name;
                document.getElementById("statement-1-player").textContent =
                    currentPlayer.statements[0];
                document.getElementById("statement-2-player").textContent =
                    currentPlayer.statements[1];
                document.getElementById("statement-3-player").textContent =
                    currentPlayer.statements[2];

                // Reset statements
                document
                    .querySelectorAll("#statement-container-player .statement")
                    .forEach((el) => {
                        el.classList.remove("truth", "lie", "selected");
                    });

                // Reset vote status
                gameState.voted = false;
                document
                    .getElementById("player-guess-instructions")
                    .classList.remove("hidden");
                document
                    .getElementById("player-vote-status")
                    .classList.add("hidden");
                document
                    .getElementById("player-waiting-reveal")
                    .classList.add("hidden");

                // If it's the current player's turn, disable voting
                if (gameState.currentPlayerId === gameState.playerId) {
                    document.getElementById(
                        "player-guess-instructions"
                    ).textContent = "These are your statements!";
                    document
                        .querySelectorAll(
                            "#statement-container-player .statement"
                        )
                        .forEach((el) => {
                            el.style.pointerEvents = "none";
                        });
                } else {
                    document.getElementById(
                        "player-guess-instructions"
                    ).textContent =
                        "Click on the statement you think is the lie!";
                    document
                        .querySelectorAll(
                            "#statement-container-player .statement"
                        )
                        .forEach((el) => {
                            el.style.pointerEvents = "auto";
                        });
                }
            }

            // Update votes display
            function updateVotesDisplay(votes) {
                const votesContainer = document.getElementById("votes-display");
                votesContainer.innerHTML = "";

                const voteCounts = { 1: 0, 2: 0, 3: 0 };
                const voterMap = {};

                Object.keys(votes).forEach((voterId) => {
                    const vote = votes[voterId];
                    if (vote && gameState.players[voterId]) {
                        voteCounts[vote]++;
                        voterMap[vote] = voterMap[vote] || [];
                        voterMap[vote].push(gameState.players[voterId].name);
                    }
                });

                for (let i = 1; i <= 3; i++) {
                    if (voteCounts[i] > 0) {
                        const voteEl = document.createElement("div");
                        voteEl.className = "vote";
                        voteEl.textContent = `Statement ${i}: ${
                            voteCounts[i]
                        } vote${voteCounts[i] > 1 ? "s" : ""} (${voterMap[
                            i
                        ].join(", ")})`;
                        votesContainer.appendChild(voteEl);
                    }
                }
            }

            // Check if player has voted
            function checkIfVoted(votes) {
                const hasVoted = votes[gameState.playerId] !== undefined;
                gameState.voted = hasVoted;

                if (hasVoted) {
                    document
                        .getElementById("player-guess-instructions")
                        .classList.add("hidden");
                    document
                        .getElementById("player-vote-status")
                        .classList.remove("hidden");
                } else {
                    document
                        .getElementById("player-guess-instructions")
                        .classList.remove("hidden");
                    document
                        .getElementById("player-vote-status")
                        .classList.add("hidden");
                }

                // Check if all players have voted
                const allPlayersVoted = Object.keys(gameState.players)
                    .filter(
                        (playerId) =>
                            playerId !== gameState.currentPlayerId &&
                            gameState.players[playerId].submitted
                    )
                    .every((playerId) => votes[playerId] !== undefined);

                if (allPlayersVoted && hasVoted) {
                    document
                        .getElementById("player-vote-status")
                        .classList.add("hidden");
                    document
                        .getElementById("player-waiting-reveal")
                        .classList.remove("hidden");
                }
            }

            // Submit player vote
            function submitVote(statementId) {
                if (
                    gameState.currentPlayerId === gameState.playerId ||
                    gameState.voted
                ) {
                    return;
                }

                database
                    .ref(
                        `games/${gameState.gameId}/votes/${gameState.playerId}`
                    )
                    .set(statementId)
                    .then(() => {
                        gameState.voted = true;
                        document
                            .getElementById("player-guess-instructions")
                            .classList.add("hidden");
                        document
                            .getElementById("player-vote-status")
                            .classList.remove("hidden");

                        // Highlight the selected statement
                        document
                            .querySelectorAll(
                                "#statement-container-player .statement"
                            )
                            .forEach((el) => {
                                el.classList.remove("selected");
                            });
                        document
                            .getElementById(`statement-${statementId}-player`)
                            .classList.add("selected");
                    })
                    .catch((error) => {
                        console.error("Error submitting vote:", error);
                    });
            }

            // Reveal the lie
            function revealLie() {
                const currentPlayer = Object.keys(gameState.players)
                    .filter((playerId) => gameState.players[playerId].submitted)
                    .map((playerId) => ({
                        id: playerId,
                        ...gameState.players[playerId],
                    }))[gameState.currentPlayerIndex];

                const lieIndex = currentPlayer.lieIndex;

                // Mark statements
                document
                    .querySelectorAll("#statement-container .statement")
                    .forEach((el, index) => {
                        const statementIndex = index + 1;
                        if (statementIndex.toString() === lieIndex) {
                            el.classList.add("lie");
                        } else {
                            el.classList.add("truth");
                        }
                    });

                // Hide reveal button, show next button
                document.getElementById("reveal-lie").classList.add("hidden");
                document
                    .getElementById("next-player")
                    .classList.remove("hidden");

                // Update game state
                database
                    .ref(`games/${gameState.gameId}/revealedLie`)
                    .set(lieIndex);
            }

            // Reveal the lie for player
            function revealLieForPlayer(lieIndex) {
                // Mark statements
                document
                    .querySelectorAll("#statement-container-player .statement")
                    .forEach((el, index) => {
                        const statementIndex = index + 1;
                        if (statementIndex.toString() === lieIndex) {
                            el.classList.add("lie");
                        } else {
                            el.classList.add("truth");
                        }
                    });

                document.getElementById("player-waiting-reveal").textContent =
                    "The lie has been revealed!";

                // Disable clicking on statements
                document
                    .querySelectorAll("#statement-container-player .statement")
                    .forEach((el) => {
                        el.style.pointerEvents = "none";
                    });
            }

            // Move to next player
            function nextPlayer() {
                const playersArray = Object.keys(gameState.players)
                    .filter((playerId) => gameState.players[playerId].submitted)
                    .map((playerId) => ({
                        id: playerId,
                        ...gameState.players[playerId],
                    }));

                const nextIndex = gameState.currentPlayerIndex + 1;

                if (nextIndex >= playersArray.length) {
                    showGameResults();
                    return;
                }

                database
                    .ref(`games/${gameState.gameId}/currentPlayerIndex`)
                    .set(nextIndex)
                    .then(() => {
                        // Clear votes and revealed lie
                        database.ref(`games/${gameState.gameId}/votes`).set({});
                        database
                            .ref(`games/${gameState.gameId}/revealedLie`)
                            .set(null);
                    })
                    .catch((error) => {
                        console.error("Error moving to next player:", error);
                    });
            }

            // Show game results
            function showGameResults() {
                database
                    .ref(`games/${gameState.gameId}/status`)
                    .set("results")
                    .then(() => {
                        showScreen("gameResults");

                        const resultsContainer =
                            document.getElementById("results-container");
                        resultsContainer.innerHTML =
                            "<h3>Game Complete!</h3><p>Thanks for playing!</p>";

                        // Add play again button functionality
                        document
                            .getElementById("play-again")
                            .addEventListener("click", () => {
                                if (gameState.isHost) {
                                    resetGame();
                                } else {
                                    resetPlayerForNewGame();
                                }
                            });

                        // Add exit button functionality
                        document
                            .getElementById("exit-game")
                            .addEventListener("click", () => {
                                exitGame();
                            });
                    })
                    .catch((error) => {
                        console.error("Error showing game results:", error);
                    });
            }

            // Reset game for a new round
            function resetGame() {
                database
                    .ref(`games/${gameState.gameId}`)
                    .update({
                        status: "lobby",
                        currentPlayerIndex: 0,
                        votes: null,
                        revealedLie: null,
                    })
                    .then(() => {
                        // Reset all players to not submitted
                        const updates = {};
                        Object.keys(gameState.players).forEach((playerId) => {
                            updates[`players/${playerId}/submitted`] = false;
                        });

                        return database
                            .ref(`games/${gameState.gameId}`)
                            .update(updates);
                    })
                    .then(() => {
                        showScreen("hostLobby");
                        gameState.gameStarted = false;
                    })
                    .catch((error) => {
                        console.error("Error resetting game:", error);
                    });
            }

            // Reset player for new game
            function resetPlayerForNewGame() {
                database
                    .ref(
                        `games/${gameState.gameId}/players/${gameState.playerId}`
                    )
                    .update({
                        submitted: false,
                    })
                    .then(() => {
                        showScreen("playerInput");
                        gameState.gameStarted = false;
                    })
                    .catch((error) => {
                        console.error("Error resetting player:", error);
                    });
            }

            // End/leave game
            function exitGame() {
                if (gameState.gameId) {
                    if (gameState.isHost) {
                        // If host, remove the entire game
                        database.ref(`games/${gameState.gameId}`).remove();
                    } else {
                        // If player, just remove themselves
                        database
                            .ref(
                                `games/${gameState.gameId}/players/${gameState.playerId}`
                            )
                            .remove();
                    }
                }

                // Reset game state
                gameState = {
                    gameId: null,
                    playerId: null,
                    playerName: "",
                    isHost: false,
                    players: {},
                    currentPlayerIndex: 0,
                    currentPlayerId: null,
                    revealedLie: false,
                    voted: false,
                    gameStarted: false,
                };

                // Go back to home screen
                showScreen("home");
            }

            // Copy link to clipboard
            function copyLinkToClipboard() {
                const link = document.getElementById("copy-link").textContent;
                navigator.clipboard
                    .writeText(link)
                    .then(() => {
                        alert("Link copied to clipboard!");
                    })
                    .catch((error) => {
                        console.error("Error copying link:", error);
                        // Fallback
                        const tempInput = document.createElement("input");
                        tempInput.value = link;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand("copy");
                        document.body.removeChild(tempInput);
                        alert("Link copied to clipboard!");
                    });
            }

            // Check URL for game code
            function checkUrlForGameCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const gameCode = urlParams.get("game");

                if (gameCode) {
                    document.getElementById("game-code-input").value = gameCode;
                    showScreen("join");
                }
            }

            // Initialize the app
            function init() {
                // Check URL for game code
                checkUrlForGameCode();

                // Set up event listeners
                document
                    .getElementById("create-game")
                    .addEventListener("click", createGame);
                document
                    .getElementById("join-game")
                    .addEventListener("click", () => showScreen("join"));
                document
                    .getElementById("join-game-submit")
                    .addEventListener("click", joinGame);
                document
                    .getElementById("back-to-home")
                    .addEventListener("click", () => showScreen("home"));
                document
                    .getElementById("submit-statements")
                    .addEventListener("click", submitStatements);
                document
                    .getElementById("start-game")
                    .addEventListener("click", startGame);
                document
                    .getElementById("leave-game")
                    .addEventListener("click", exitGame);
                document
                    .getElementById("leave-game-player")
                    .addEventListener("click", exitGame);
                document
                    .getElementById("reveal-lie")
                    .addEventListener("click", revealLie);
                document
                    .getElementById("next-player")
                    .addEventListener("click", nextPlayer);
                document
                    .getElementById("end-game")
                    .addEventListener("click", exitGame);
                document
                    .getElementById("copy-link-btn")
                    .addEventListener("click", copyLinkToClipboard);

                // Add event listeners for voting
                document
                    .querySelectorAll("#statement-container-player .statement")
                    .forEach((el) => {
                        el.addEventListener("click", () => {
                            if (
                                gameState.currentPlayerId !==
                                    gameState.playerId &&
                                !gameState.voted
                            ) {
                                submitVote(el.dataset.id);
                            }
                        });
                    });
            }

            // Initialize when DOM is loaded
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
