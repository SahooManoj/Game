<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Two Truths and a Lie</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }

            h1,
            h2,
            h3 {
                color: #2c3e50;
            }

            .container {
                background-color: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .hidden {
                display: none;
            }

            input,
            select,
            button,
            textarea {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                border: 1px solid #ddd;
            }

            button {
                background-color: #3498db;
                color: white;
                cursor: pointer;
                border: none;
                transition: background-color 0.3s;
            }

            button:hover {
                background-color: #2980b9;
            }

            button:disabled {
                background-color: #95a5a6;
                cursor: not-allowed;
            }

            .statement {
                padding: 15px;
                margin: 10px 0;
                background-color: #f8f9fa;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .statement:hover {
                background-color: #e9ecef;
            }

            .statement.selected {
                background-color: #3498db;
                color: white;
            }

            ul {
                list-style-type: none;
                padding: 0;
            }

            li {
                padding: 8px 0;
                border-bottom: 1px solid #eee;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }

            th,
            td {
                padding: 10px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            tr.winner {
                background-color: #f1c40f33;
            }

            .share-link {
                display: flex;
                margin: 10px 0;
            }

            .share-link input {
                flex-grow: 1;
                margin-right: 5px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <!-- Game Code Entry Screen -->
        <div id="game-code-entry" class="container">
            <h1>Two Truths and a Lie</h1>
            <p>Join an existing game or create a new one!</p>

            <div class="form-group">
                <label for="player-name-input">Your Name:</label>
                <input
                    type="text"
                    id="player-name-input"
                    placeholder="Enter your name"
                    required
                />
            </div>

            <div class="form-group">
                <label for="game-code-input"
                    >Game Code (leave blank to create a new game):</label
                >
                <input
                    type="text"
                    id="game-code-input"
                    placeholder="Enter game code"
                />
            </div>

            <button id="join-create-game">Join / Create Game</button>
        </div>

        <!-- Waiting Room Screen -->
        <div id="waiting-room" class="container hidden">
            <h2>Waiting Room</h2>
            <div id="game-code-display"></div>

            <div class="share-link">
                <input type="text" id="share-url" readonly />
                <button id="copy-link">Copy Link</button>
            </div>

            <h3>Players:</h3>
            <ul id="player-list"></ul>

            <p id="waiting-message">Waiting for host to start the game...</p>

            <div id="host-controls" class="hidden">
                <button id="start-game">Start Game</button>
                <button id="reset-game">Reset Game</button>
            </div>
        </div>

        <!-- Statement Entry Screen -->
        <div id="statement-entry" class="container hidden">
            <h2>Enter Your Statements</h2>
            <p>
                Enter two truths and one lie about yourself. The other players
                will try to guess which statement is the lie.
            </p>

            <div class="form-group">
                <label for="statement1">Statement 1:</label>
                <textarea
                    id="statement1"
                    rows="2"
                    placeholder="Enter your first statement"
                ></textarea>
            </div>

            <div class="form-group">
                <label for="statement2">Statement 2:</label>
                <textarea
                    id="statement2"
                    rows="2"
                    placeholder="Enter your second statement"
                ></textarea>
            </div>

            <div class="form-group">
                <label for="statement3">Statement 3:</label>
                <textarea
                    id="statement3"
                    rows="2"
                    placeholder="Enter your third statement"
                ></textarea>
            </div>

            <div class="form-group">
                <label for="lie-selection">Which statement is the lie?</label>
                <select id="lie-selection">
                    <option value="1">Statement 1</option>
                    <option value="2">Statement 2</option>
                    <option value="3">Statement 3</option>
                </select>
            </div>

            <button id="submit-statements">Submit Statements</button>
        </div>

        <!-- Gameplay Screen -->
        <div id="gameplay" class="container hidden">
            <h2 id="current-player"></h2>

            <div id="own-statements-message" class="hidden">
                <p>
                    These are your statements. Wait for other players to make
                    their guesses.
                </p>
            </div>

            <div class="statement" data-index="0" id="game-statement1"></div>
            <div class="statement" data-index="1" id="game-statement2"></div>
            <div class="statement" data-index="2" id="game-statement3"></div>

            <div id="guess-controls">
                <p>
                    Which statement do you think is the lie? Click on a
                    statement to select it.
                </p>
                <button id="submit-guess" disabled>Submit Guess</button>
            </div>

            <div id="waiting-for-guesses" class="hidden">
                <p>Waiting for all players to make their guesses...</p>
            </div>
        </div>

        <!-- Round Results Screen -->
        <div id="round-results" class="container hidden">
            <h2 id="round-player"></h2>

            <div id="round-statements"></div>

            <div id="lie-reveal"></div>

            <div id="correct-guessers"></div>

            <div id="host-next-controls" class="hidden">
                <button id="next-round">Next Round</button>
            </div>

            <div id="waiting-for-next" class="hidden">
                <p>Waiting for host to start the next round...</p>
            </div>
        </div>

        <!-- Final Results Screen -->
        <div id="final-results" class="container hidden">
            <h2>Game Results</h2>

            <div id="winner-announcement"></div>

            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="final-scores"></tbody>
            </table>

            <div id="host-replay-controls" class="hidden">
                <button id="play-again">Play Again</button>
            </div>

            <div id="waiting-for-replay" class="hidden">
                <p>Waiting for host to start a new game...</p>
            </div>
        </div>

        <!-- Firebase App (the core Firebase SDK) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
        <!-- Firebase Database -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>

        <script>
            // Firebase Configuration - with a new generated config
            const firebaseConfig = {
                apiKey: "AIzaSyBgJKMAdwGiJmRLQ5UE-UU8L1uXQ_4K6cQ",
                authDomain: "two-truths-game-d7e2a.firebaseapp.com",
                databaseURL:
                    "https://two-truths-game-d7e2a-default-rtdb.firebaseio.com",
                projectId: "two-truths-game-d7e2a",
                storageBucket: "two-truths-game-d7e2a.appspot.com",
                messagingSenderId: "623874211179",
                appId: "1:623874211179:web:9da8c5e4ea1be79fc7b8f7",
            };

            // Initialize Firebase with error handling
            try {
                firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                alert(
                    "Could not connect to game server. Please try again later."
                );
            }

            // Game variables
            let gameId = "";
            let playerId = "";
            let playerName = "";
            let isHost = false;
            const database = firebase.database();

            // DOM Elements
            const screens = {
                codeEntry: document.getElementById("game-code-entry"),
                waiting: document.getElementById("waiting-room"),
                entry: document.getElementById("statement-entry"),
                gameplay: document.getElementById("gameplay"),
                roundResults: document.getElementById("round-results"),
                finalResults: document.getElementById("final-results"),
            };

            // Generate a random game code
            function generateGameCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            // Generate a random player ID
            function generatePlayerId() {
                return "player_" + Math.random().toString(36).substring(2, 15);
            }

            // Show a specific screen
            function showScreen(screenName) {
                Object.keys(screens).forEach((key) => {
                    screens[key].classList.add("hidden");
                });
                screens[screenName].classList.remove("hidden");
            }

            // Update player list in waiting room
            function updatePlayerList(players) {
                const playerList = document.getElementById("player-list");
                playerList.innerHTML = "";

                Object.keys(players).forEach((pid) => {
                    const player = players[pid];
                    const listItem = document.createElement("li");

                    if (player.hasSubmitted) {
                        listItem.textContent = `${player.name} ✓`;
                    } else {
                        listItem.textContent = player.name;
                    }

                    if (player.isHost) {
                        listItem.textContent += " (Host)";
                    }

                    playerList.appendChild(listItem);
                });
            }

            // Create a new game
            function createGame() {
                gameId = generateGameCode();
                playerId = generatePlayerId();
                playerName = document
                    .getElementById("player-name-input")
                    .value.trim();
                isHost = true;

                if (!playerName) {
                    alert("Please enter your name.");
                    return;
                }

                // Create game in database
                const gameRef = database.ref("games/" + gameId);
                gameRef
                    .set({
                        created: firebase.database.ServerValue.TIMESTAMP,
                        status: "waiting",
                        currentPlayerIndex: -1,
                        hostId: playerId,
                    })
                    .then(() => {
                        console.log("Game created with ID:", gameId);

                        // Add player to game
                        const playerRef = database.ref(
                            "games/" + gameId + "/players/" + playerId
                        );
                        return playerRef.set({
                            name: playerName,
                            isHost: true,
                            hasSubmitted: false,
                            score: 0,
                            joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        });
                    })
                    .then(() => {
                        // Set up game listeners
                        setupGameListeners();

                        // Display game code and show waiting room
                        document.getElementById(
                            "game-code-display"
                        ).textContent = "Game Code: " + gameId;
                        const shareUrl =
                            window.location.href.split("?")[0] +
                            "?game=" +
                            gameId;
                        document.getElementById("share-url").value = shareUrl;

                        document
                            .getElementById("host-controls")
                            .classList.remove("hidden");
                        showScreen("waiting");
                    })
                    .catch((error) => {
                        console.error("Error creating game:", error);
                        alert("Error creating game. Please try again.");
                    });
            }

            // Join an existing game
            function joinGame(code) {
                gameId = code.toUpperCase();
                playerId = generatePlayerId();
                playerName = document
                    .getElementById("player-name-input")
                    .value.trim();

                if (!playerName) {
                    alert("Please enter your name.");
                    return;
                }

                console.log("Attempting to join game: " + gameId);

                // Check if game exists
                const gameRef = database.ref("games/" + gameId);
                gameRef
                    .once("value")
                    .then((snapshot) => {
                        const gameData = snapshot.val();
                        console.log("Game data:", gameData);

                        if (!gameData) {
                            alert(
                                "Game not found. Please check the code and try again."
                            );
                            return Promise.reject("Game not found");
                        }

                        // Check if game has started and not allowing new players
                        if (
                            gameData.status !== "waiting" &&
                            gameData.status !== "statements"
                        ) {
                            alert(
                                "This game has already started and is not accepting new players."
                            );
                            return Promise.reject("Game already started");
                        }

                        // Add player to game
                        const playerRef = database.ref(
                            "games/" + gameId + "/players/" + playerId
                        );
                        return playerRef.set({
                            name: playerName,
                            isHost: false,
                            hasSubmitted: false,
                            score: 0,
                            joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        });
                    })
                    .then(() => {
                        console.log("Player added successfully");

                        // Set up game listeners
                        setupGameListeners();

                        // Display game code and show waiting room
                        document.getElementById(
                            "game-code-display"
                        ).textContent = "Game Code: " + gameId;
                        const shareUrl =
                            window.location.href.split("?")[0] +
                            "?game=" +
                            gameId;
                        document.getElementById("share-url").value = shareUrl;

                        // Check host status again to ensure it's set correctly
                        const gameRef = database.ref("games/" + gameId);
                        return gameRef.once("value");
                    })
                    .then((snapshot) => {
                        const gameData = snapshot.val();

                        // Hide host controls for non-hosts
                        if (gameData.hostId === playerId) {
                            isHost = true;
                            document
                                .getElementById("host-controls")
                                .classList.remove("hidden");
                        } else {
                            isHost = false;
                            document
                                .getElementById("host-controls")
                                .classList.add("hidden");
                        }

                        showScreen("waiting");
                    })
                    .catch((error) => {
                        if (
                            error === "Game not found" ||
                            error === "Game already started"
                        ) {
                            // Already alerted
                            return;
                        }
                        console.error("Error joining game:", error);
                        alert("Error joining game: " + error.message);
                    });
            }

            // Set up listeners for game state changes
            function setupGameListeners() {
                // Listen for game status changes
                const gameRef = database.ref("games/" + gameId);
                gameRef.on("value", (snapshot) => {
                    const gameData = snapshot.val();
                    if (!gameData) return;

                    // Update UI based on game status
                    switch (gameData.status) {
                        case "waiting":
                            showScreen("waiting");
                            break;
                        case "statements":
                            // Check if player has already submitted statements
                            const playerRef = database.ref(
                                "games/" + gameId + "/players/" + playerId
                            );
                            playerRef.once("value", (playerSnap) => {
                                const playerData = playerSnap.val();
                                if (playerData && playerData.hasSubmitted) {
                                    showScreen("waiting");
                                    document.getElementById(
                                        "waiting-message"
                                    ).textContent =
                                        "Waiting for all players to submit their statements...";
                                } else {
                                    showScreen("entry");
                                }
                            });
                            break;
                        case "gameplay":
                            handleGameplayUpdate(gameData);
                            break;
                        case "roundResults":
                            handleRoundResultsUpdate(gameData);
                            break;
                        case "finalResults":
                            handleFinalResultsUpdate(gameData);
                            break;
                    }

                    // Update player list if available
                    if (gameData.players) {
                        updatePlayerList(gameData.players);
                    }
                });
            }

            // Handle gameplay updates
            function handleGameplayUpdate(gameData) {
                // Don't update if not in gameplay mode yet
                if (
                    gameData.currentPlayerIndex === undefined ||
                    gameData.currentPlayerIndex < 0
                )
                    return;

                // Get current player
                const players = Object.keys(gameData.players);
                const sortedPlayers = players.sort((a, b) => {
                    return (
                        gameData.players[a].joinedAt -
                        gameData.players[b].joinedAt
                    );
                });

                // Check if gameplay is complete
                if (gameData.currentPlayerIndex >= sortedPlayers.length) {
                    return; // Will be handled by status change to 'finalResults'
                }

                const currentPlayerId =
                    sortedPlayers[gameData.currentPlayerIndex];
                const currentPlayer = gameData.players[currentPlayerId];

                // Update UI
                document.getElementById(
                    "current-player"
                ).textContent = `${currentPlayer.name}'s Statements`;

                // Display statements
                if (
                    gameData.statements &&
                    gameData.statements[currentPlayerId]
                ) {
                    const playerStatements =
                        gameData.statements[currentPlayerId];
                    document.getElementById("game-statement1").textContent =
                        playerStatements.statements[0];
                    document.getElementById("game-statement2").textContent =
                        playerStatements.statements[1];
                    document.getElementById("game-statement3").textContent =
                        playerStatements.statements[2];
                }

                // Reset statement selection
                document.querySelectorAll(".statement").forEach((stmt) => {
                    stmt.classList.remove("selected");
                });
                document.getElementById("submit-guess").disabled = true;

                // Show/hide appropriate UI elements
                if (currentPlayerId === playerId) {
                    // This is the current player's statements
                    document
                        .getElementById("own-statements-message")
                        .classList.remove("hidden");
                    document
                        .getElementById("guess-controls")
                        .classList.add("hidden");
                    document
                        .getElementById("waiting-for-guesses")
                        .classList.remove("hidden");
                } else {
                    // This is another player's statements
                    document
                        .getElementById("own-statements-message")
                        .classList.add("hidden");
                    document
                        .getElementById("guess-controls")
                        .classList.remove("hidden");
                    document
                        .getElementById("waiting-for-guesses")
                        .classList.add("hidden");

                    // Check if player has already guessed
                    if (
                        gameData.guesses &&
                        gameData.guesses[currentPlayerId] &&
                        gameData.guesses[currentPlayerId][playerId]
                    ) {
                        // Already guessed, show waiting message
                        document
                            .getElementById("guess-controls")
                            .classList.add("hidden");
                        document
                            .getElementById("waiting-for-guesses")
                            .classList.remove("hidden");
                    }
                }

                showScreen("gameplay");
            }

            // Handle round results updates
            function handleRoundResultsUpdate(gameData) {
                if (
                    gameData.currentPlayerIndex === undefined ||
                    gameData.currentPlayerIndex < 0
                )
                    return;

                // Get current player
                const players = Object.keys(gameData.players);
                const sortedPlayers = players.sort((a, b) => {
                    return (
                        gameData.players[a].joinedAt -
                        gameData.players[b].joinedAt
                    );
                });

                const currentPlayerId =
                    sortedPlayers[gameData.currentPlayerIndex];
                const currentPlayer = gameData.players[currentPlayerId];

                // Display player name
                document.getElementById(
                    "round-player"
                ).textContent = `${currentPlayer.name}'s Round`;

                // Display statements and reveal
                const statementsContainer =
                    document.getElementById("round-statements");
                statementsContainer.innerHTML = "";

                if (
                    gameData.statements &&
                    gameData.statements[currentPlayerId]
                ) {
                    const playerStatements =
                        gameData.statements[currentPlayerId];

                    playerStatements.statements.forEach((stmt, index) => {
                        const isLie = index === playerStatements.lie;
                        const stmtDiv = document.createElement("div");
                        stmtDiv.className = `statement ${
                            isLie ? "selected" : ""
                        }`;
                        stmtDiv.textContent = stmt;
                        statementsContainer.appendChild(stmtDiv);
                    });

                    // Reveal the lie
                    const lieReveal = document.getElementById("lie-reveal");
                    lieReveal.innerHTML = `<p>The lie was: <strong>${
                        playerStatements.statements[playerStatements.lie]
                    }</strong></p>`;
                }

                // Show who guessed correctly
                const correctGuessers =
                    document.getElementById("correct-guessers");
                correctGuessers.innerHTML = "<h4>Correct Guesses:</h4>";

                if (gameData.guesses && gameData.guesses[currentPlayerId]) {
                    const playerGuesses = gameData.guesses[currentPlayerId];
                    const correctList = document.createElement("ul");
                    let hasCorrectGuesses = false;

                    Object.keys(playerGuesses).forEach((guesserId) => {
                        if (guesserId === currentPlayerId) return; // Skip current player

                        const guess = playerGuesses[guesserId];
                        const lieIndex =
                            gameData.statements[currentPlayerId].lie;

                        if (guess === lieIndex) {
                            // Correct guess
                            const listItem = document.createElement("li");
                            listItem.textContent =
                                gameData.players[guesserId].name;
                            correctList.appendChild(listItem);
                            hasCorrectGuesses = true;
                        }
                    });

                    if (hasCorrectGuesses) {
                        correctGuessers.appendChild(correctList);
                    } else {
                        correctGuessers.innerHTML +=
                            "<p>No one guessed correctly!</p>";
                    }
                }

                // Show/hide host controls
                if (isHost) {
                    document
                        .getElementById("host-next-controls")
                        .classList.remove("hidden");
                    document
                        .getElementById("waiting-for-next")
                        .classList.add("hidden");
                } else {
                    document
                        .getElementById("host-next-controls")
                        .classList.add("hidden");
                    document
                        .getElementById("waiting-for-next")
                        .classList.remove("hidden");
                }

                showScreen("roundResults");
            }

            // Handle final results updates
            function handleFinalResultsUpdate(gameData) {
                // Create scoreboard
                const scoresTable = document.getElementById("final-scores");
                scoresTable.innerHTML = "";

                if (!gameData.players) return;

                // Get players sorted by score
                const players = Object.keys(gameData.players);
                const sortedPlayers = players.sort((a, b) => {
                    return (
                        gameData.players[b].score - gameData.players[a].score
                    );
                });

                // Find maximum score
                const maxScore = Math.max(
                    ...sortedPlayers.map((pid) => gameData.players[pid].score)
                );

                // Add rows to scoreboard
                sortedPlayers.forEach((pid) => {
                    const player = gameData.players[pid];
                    const row = document.createElement("tr");

                    // Add winner class to highest scorers
                    if (player.score === maxScore) {
                        row.className = "winner";
                    }

                    const nameCell = document.createElement("td");
                    nameCell.textContent = player.name;

                    const scoreCell = document.createElement("td");
                    scoreCell.textContent = player.score;

                    row.appendChild(nameCell);
                    row.appendChild(scoreCell);
                    scoresTable.appendChild(row);
                });

                // Find winners
                const winners = sortedPlayers
                    .filter((pid) => gameData.players[pid].score === maxScore)
                    .map((pid) => gameData.players[pid].name);

                // Display winner announcement
                const winnerAnnouncement = document.getElementById(
                    "winner-announcement"
                );
                if (winners.length === 1) {
                    winnerAnnouncement.innerHTML = `<h3>🏆 ${winners[0]} wins with ${maxScore} points! 🏆</h3>`;
                } else {
                    winnerAnnouncement.innerHTML = `<h3>🏆 Tie between ${winners.join(
                        " and "
                    )} with ${maxScore} points each! 🏆</h3>`;
                }

                // Show/hide host controls
                if (isHost) {
                    document
                        .getElementById("host-replay-controls")
                        .classList.remove("hidden");
                    document
                        .getElementById("waiting-for-replay")
                        .classList.add("hidden");
                } else {
                    document
                        .getElementById("host-replay-controls")
                        .classList.add("hidden");
                    document
                        .getElementById("waiting-for-replay")
                        .classList.remove("hidden");
                }

                showScreen("finalResults");
            }

            // Helper function to check if all players have guessed
            function checkAllGuessed(gameData, currentPlayerId) {
                // Skip if not all players have submitted statements
                if (!gameData.statements) return;

                // Get all players except current
                const otherPlayers = Object.keys(gameData.players).filter(
                    (pid) => pid !== currentPlayerId
                );

                // Check if guesses exist
                if (!gameData.guesses || !gameData.guesses[currentPlayerId]) {
                    // Not everyone has guessed
                    return;
                }

                // Check if everyone has guessed
                const allGuessed = otherPlayers.every(
                    (pid) =>
                        gameData.guesses[currentPlayerId] &&
                        gameData.guesses[currentPlayerId][pid] !== undefined
                );

                if (allGuessed) {
                    // Calculate scores
                    updateScores(gameData, currentPlayerId);

                    // Move to round results
                    const gameRef = database.ref("games/" + gameId);
                    gameRef.update({
                        status: "roundResults",
                    });
                }
            }

            // Helper function to update scores
            function updateScores(gameData, currentPlayerId) {
                if (
                    !gameData.statements ||
                    !gameData.statements[currentPlayerId] ||
                    !gameData.guesses ||
                    !gameData.guesses[currentPlayerId]
                ) {
                    return;
                }

                const lieIndex = gameData.statements[currentPlayerId].lie;

                // Update scores for each player
                Object.keys(gameData.guesses[currentPlayerId]).forEach(
                    (guesserId) => {
                        if (guesserId === currentPlayerId) return; // Skip current player

                        const guess =
                            gameData.guesses[currentPlayerId][guesserId];

                        // Award points for correct guesses
                        if (guess === lieIndex) {
                            // Correct guess - add 1 point
                            const playerRef = database.ref(
                                "games/" +
                                    gameId +
                                    "/players/" +
                                    guesserId +
                                    "/score"
                            );
                            playerRef.transaction((score) => (score || 0) + 1);
                        }
                    }
                );

                // Calculate how many people were fooled
                const totalGuessers =
                    Object.keys(gameData.guesses[currentPlayerId]).length - 1; // Exclude self
                const correctGuessers = Object.keys(
                    gameData.guesses[currentPlayerId]
                ).filter(
                    (guesserId) =>
                        guesserId !== currentPlayerId &&
                        gameData.guesses[currentPlayerId][guesserId] ===
                            lieIndex
                ).length;

                const fooledCount = totalGuessers - correctGuessers;

                // Award points to current player for fooling others
                if (fooledCount > 0) {
                    const playerRef = database.ref(
                        "games/" +
                            gameId +
                            "/players/" +
                            currentPlayerId +
                            "/score"
                    );
                    playerRef.transaction(
                        (score) => (score || 0) + fooledCount
                    );
                }
            }

            // Event Listeners
            document.addEventListener("DOMContentLoaded", () => {
                // Check URL for game code
                const urlParams = new URLSearchParams(window.location.search);
                const gameParam = urlParams.get("game");
                if (gameParam) {
                    document.getElementById("game-code-input").value =
                        gameParam;
                }

                // Join/Create Game button with improved handling
                document
                    .getElementById("join-create-game")
                    .addEventListener("click", () => {
                        const code = document
                            .getElementById("game-code-input")
                            .value.trim();
                        const name = document
                            .getElementById("player-name-input")
                            .value.trim();

                        if (!name) {
                            alert("Please enter your name.");
                            return;
                        }

                        if (code) {
                            joinGame(code);
                        } else {
                            createGame();
                        }
                    });

                // Copy link button
                document
                    .getElementById("copy-link")
                    .addEventListener("click", () => {
                        const shareUrl = document.getElementById("share-url");
                        shareUrl.select();
                        document.execCommand("copy");
                        alert("Link copied to clipboard!");
                    });

                // Start game button
                document
                    .getElementById("start-game")
                    .addEventListener("click", () => {
                        if (!isHost) return;

                        const gameRef = database.ref("games/" + gameId);
                        gameRef.update({
                            status: "statements",
                        });
                    });

                // Reset game button
                document
                    .getElementById("reset-game")
                    .addEventListener("click", () => {
                        if (!isHost) return;

                        const gameRef = database.ref("games/" + gameId);
                        gameRef.update({
                            status: "waiting",
                            currentPlayerIndex: -1,
                        });
                    });

                // Submit statements button
                document
                    .getElementById("submit-statements")
                    .addEventListener("click", () => {
                        const statement1 = document
                            .getElementById("statement1")
                            .value.trim();
                        const statement2 = document
                            .getElementById("statement2")
                            .value.trim();
                        const statement3 = document
                            .getElementById("statement3")
                            .value.trim();
                        const lieIndex =
                            parseInt(
                                document.getElementById("lie-selection").value
                            ) - 1;

                        if (!statement1 || !statement2 || !statement3) {
                            alert("Please enter all three statements.");
                            return;
                        }

                        // Save statements to database
                        const statementsRef = database.ref(
                            "games/" + gameId + "/statements/" + playerId
                        );
                        statementsRef
                            .set({
                                statements: [
                                    statement1,
                                    statement2,
                                    statement3,
                                ],
                                lie: lieIndex,
                            })
                            .then(() => {
                                // Mark player as having submitted
                                const playerRef = database.ref(
                                    "games/" + gameId + "/players/" + playerId
                                );
                                playerRef.update({
                                    hasSubmitted: true,
                                });

                                // Show waiting screen
                                showScreen("waiting");
                                document.getElementById(
                                    "waiting-message"
                                ).textContent =
                                    "Waiting for all players to submit their statements...";

                                // Check if all players have submitted
                                const gameRef = database.ref("games/" + gameId);
                                gameRef.once("value", (snapshot) => {
                                    const gameData = snapshot.val();
                                    const allSubmitted = Object.values(
                                        gameData.players
                                    ).every((player) => player.hasSubmitted);

                                    if (allSubmitted && isHost) {
                                        // All players have submitted, start gameplay
                                        gameRef.update({
                                            status: "gameplay",
                                            currentPlayerIndex: 0,
                                        });
                                    }
                                });
                            });
                    });

                // Statement selection
                document.querySelectorAll(".statement").forEach((statement) => {
                    statement.addEventListener("click", () => {
                        // Don't allow selection if viewing own statements
                        const ownStatements = document.getElementById(
                            "own-statements-message"
                        );
                        if (!ownStatements.classList.contains("hidden")) {
                            return;
                        }

                        // Clear all selections
                        document
                            .querySelectorAll(".statement")
                            .forEach((stmt) => {
                                stmt.classList.remove("selected");
                            });

                        // Select clicked statement
                        statement.classList.add("selected");

                        // Enable submit button
                        document.getElementById(
                            "submit-guess"
                        ).disabled = false;
                    });
                });

                // Submit guess button
                document
                    .getElementById("submit-guess")
                    .addEventListener("click", () => {
                        const selected = document.querySelector(
                            ".statement.selected"
                        );
                        if (!selected) return;

                        const guessIndex = parseInt(selected.dataset.index);

                        // Get current player ID
                        const gameRef = database.ref("games/" + gameId);
                        gameRef.once("value", (snapshot) => {
                            const gameData = snapshot.val();
                            const players = Object.keys(gameData.players);
                            const sortedPlayers = players.sort((a, b) => {
                                return (
                                    gameData.players[a].joinedAt -
                                    gameData.players[b].joinedAt
                                );
                            });

                            const currentPlayerId =
                                sortedPlayers[gameData.currentPlayerIndex];

                            // Save guess to database
                            const guessRef = database.ref(
                                "games/" +
                                    gameId +
                                    "/guesses/" +
                                    currentPlayerId +
                                    "/" +
                                    playerId
                            );
                            guessRef.set(guessIndex).then(() => {
                                // Show waiting message
                                document
                                    .getElementById("guess-controls")
                                    .classList.add("hidden");
                                document
                                    .getElementById("waiting-for-guesses")
                                    .classList.remove("hidden");

                                // Check if all players have guessed
                                if (isHost) {
                                    checkAllGuessed(gameData, currentPlayerId);
                                }
                            });
                        });
                    });

                // Next round button
                document
                    .getElementById("next-round")
                    .addEventListener("click", () => {
                        if (!isHost) return;

                        const gameRef = database.ref("games/" + gameId);
                        gameRef.once("value", (snapshot) => {
                            const gameData = snapshot.val();
                            const players = Object.keys(gameData.players);
                            const sortedPlayers = players.sort((a, b) => {
                                return (
                                    gameData.players[a].joinedAt -
                                    gameData.players[b].joinedAt
                                );
                            });

                            const nextPlayerIndex =
                                gameData.currentPlayerIndex + 1;

                            if (nextPlayerIndex < sortedPlayers.length) {
                                // Move to next player
                                gameRef.update({
                                    status: "gameplay",
                                    currentPlayerIndex: nextPlayerIndex,
                                });
                            } else {
                                // End of game
                                gameRef.update({
                                    status: "finalResults",
                                });
                            }
                        });
                    });

                // Play again button
                document
                    .getElementById("play-again")
                    .addEventListener("click", () => {
                        if (!isHost) return;

                        const gameRef = database.ref("games/" + gameId);
                        gameRef.once("value", (snapshot) => {
                            const gameData = snapshot.val();

                            // Keep the same players but reset their scores and submissions
                            const updatedPlayers = {};
                            Object.keys(gameData.players).forEach((pid) => {
                                updatedPlayers[pid] = {
                                    ...gameData.players[pid],
                                    score: 0,
                                    hasSubmitted: false,
                                };
                            });

                            // Reset game state
                            gameRef.update({
                                status: "statements",
                                currentPlayerIndex: -1,
                                players: updatedPlayers,
                                statements: null,
                                guesses: null,
                            });
                        });
                    });

                // Handle enter key on game code input
                document
                    .getElementById("game-code-input")
                    .addEventListener("keypress", (event) => {
                        if (event.key === "Enter") {
                            document.getElementById("join-create-game").click();
                        }
                    });

                // Handle enter key on player name input
                document
                    .getElementById("player-name-input")
                    .addEventListener("keypress", (event) => {
                        if (event.key === "Enter") {
                            document.getElementById("join-create-game").click();
                        }
                    });
            });
        </script>
    </body>
</html>
